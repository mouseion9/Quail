(in-package :q-user)

(defvar smoke-data
  NIL
  "From Hand and Taylor page 180.")

(let ((smoke-vars '("sex" "age" "tar" "nicotine" "carbon monoxide"
                    "puffed smoke" "blood nicotine" "blood carbon monoxide"))
      smoke-list
      brand-names
      brands
      smokers
      )
  (<- smoke-list 
      '((2 3 180 15 183 3758.00 123  70)
        (2 3 160 10 177 4017.99 311 100)
        (2 4 160 10 177 4739.00 242 121)
        (2 2 180 13 177 6827.79 474  91)
        (2 4 190 12 183 3074.19 375 103)
        
        (2 5 180 15 183 6716.99 449  87)
        (2 4 170 13 165 4065.79 419  88)
        (1 6 160 11 133 4405.59 185  53)
        (2 6 190 14 196 4575.40  33  53)
        (2 6 180 15 183 6343.99 564  54)
        
        (1 4  90  5 144 6788.99 256  91)
        (2 4 180 13 188 3539.79 242  97)
        (1 2 180 13 177 7273.79 312  42)
        (2 4  80  7 113 7446.19 179  61)
        (1 3 190 14 196 7369.39 456  85)
        
        (2 3 190 13 157 4150.79 232  55)
        (2 5 190 15 190 5688.99 389  84)
        (1 4 160 11 133 6341.59 429  57)
        (2 5 180 13 188 5194.79 309  66)
        (2 3 190 12 183 5005.19 269  69)
        
        (2 2 150  7 201 4270.20 274 108)
        (1 4 180 15 183 6164.99 274  84)
        (2 4 120 13 115 6410.79 157  50)
        (1 2 180 15 183 7169.99 348  95)
        (2 2 130  9 168 4538.39 384 119)
        
        (2 2 180 14 180 4521.39 274  72)
        (2 2 150 11 156 5931.60 179  59)
        (1 5 190 14 196 5400.39 306  66)
        (2 2 190 12 183 3590.19 260  46)
        (2 3  90  9 123 8502.90 346  86)
        
        (1 3 180 15 183 6828.99 106  28)
        (1 4 190 14 196 6256.39 468  96)
        (1 2 180 13 177 8045.80 597 155)
        (2 2 180 15 183 5251.99 233  84)
        (2 2 190 14 196 5649.39 304  94)
        
        (2 4  90  9 123 7225.39 448 109)
        (1 4  90  5 144 5761.99 182 109)
        (2 3 180 15 183 7766.99 527 100)
        (1 5 190 14 196 3541.39 155  56)
        (1 2 190 12 183 6004.19 347  79)
        
        (1 6 190 13 157 3559.79  74  34)
        (2 2 120  6 191 5812.59 471  86)
        (1 3 180 15 183 6469.00 260  61)
        (1 3 190 14 196 5735.39 213  43)
        (2 4 190 14 196 4650.30 346  71)
        
        (1 2 180 15 183 7114.00 304  73)
        (1 4 180 15 183 3869.99 256  56)
        (1 6  90  8 110 3894.79 233  76)
        (2 3 190 12 183 2366.20 227  80)
        (1 2 180 15 183 8424.99 607  75)
        
        (2 2 180 13 171 6232.79 464  81)
        (2 4 190 14 196 4863.39 469  77)
        (1 3 180 13 177 2780.80 209  46)
        (2 2 190 12 183 4724.19 314  71)
        (1 3 150 11 156 6638.59 456 120))
      )
  
  (flet ((cig-test(c1 c2)
           (and (= (eref c1 2) (eref c2 2))
                (= (eref c1 3) (eref c2 3))
                (= (eref c1 4) (eref c2 4))))
         )
    (<- brands (remove-duplicates smoke-list :test #'cig-test))
    (<- brand-names 
        (loop for b in brands
              for i upfrom 0 collect
              (format nil "brand-~A" i)))
    
    (<- smoke-list
        (loop for s in smoke-list
              for brand = (position s brands :test #'cig-test)
              collect
              (append (list  (elt brand-names brand)) s)))
    
    (<- smoke-data (array smoke-list :dimensions '(55 9)))
    (dataset smoke-data
             :variates smoke-vars
             :identifiers (loop for i from 1 to (length smoke-list)
                                collect (format NIL "Smoker ~a" i))
             :name "Smoker data")
    "Smoker data loaded"
    )
  )



